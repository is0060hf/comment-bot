# 基本設計書（YouTubeコメントBot）

- 版: v0.2
- 作成日: 2025-10-11
- 根拠: `doc/要件定義書.md`
- 採用: Next.js（App Router）+ Vercel（UI）／ローカルエージェント（Node.js/TypeScript, macOS）
- 投稿方針（A案）: ローカルエージェントがYouTubeへ直接投稿（OAuthトークンもローカル保持）

---

## 1. システム全体構成

- 実行環境
  - Web UI: Next.js on Vercel（サーバーサイドのみで外部APIを仲介。長時間処理は持たない）
  - ローカル: macOS（Darwin 24.x）上のNode.js/TypeScript（CLI実行）
- 日本語のみ対応
- 外部APIはすべてサーバーサイド／ローカルエージェント経由で呼び出し（クライアント直フェッチ禁止）

### 1.1 コンポーネント一覧

- web-ui-next: 設定UI/方針管理（Vercelホスティング）
- audio-capture: 仮想デバイス（BlackHole/Loopback）からの音声取得（ローカル）
- stt-stream: 日本語ストリーミング音声認識（ローカル）
- context-store: 直近要約/話題/固有名詞の保持（ローカル）
- trigger-detector: コメント機会検知（ルール+LLM分類, ローカル）
- comment-generator: コメント文生成（LLM, ローカル）
- safety-filter: モデレーション/ルールフィルタ（ローカル）
- platform-youtube: YouTube投稿アダプタ（OAuth/レート制御, ローカル）
- scheduler: クールダウン/重複抑止/頻度制御（ローカル）
- config: 設定読み込み/バリデーション（ローカル）。必要に応じVercel上の設定を取り込み
- cli: 起動/停止/一時停止/安全レベル切替（ローカル）

### 1.2 データフロー（要点）

1. audio-capture → stt-stream（interim/final）
2. stt-stream → context-store（スライディング更新）
3. context-store → trigger-detector（スコアリング/分類）
4. trigger-detector → comment-generator（候補生成）
5. comment-generator → safety-filter（検査/修正/ブロック）
6. safety-filter → platform-youtube（投稿, A案: ローカルが直接YouTubeへ）
7. schedulerが頻度/重複/クールダウンを制御
8. web-ui-next は設定を編集し、ローカルは設定を同期/反映（プルまたは手動反映）

---

## 2. 外部インタフェース

- YouTube Data API v3（ローカル）: `liveChatMessages.insert`（投稿）
- STTプロバイダ（ローカル）: Deepgram/GCP/Whisper API（選択式）
- モデレーション（ローカル）: OpenAI Moderation（選択式）
- 設定同期（任意）: Vercel（Edge Config /
  KV等）を介したサーバーサイドの設定提供。秘密情報・トークンは保管しない

認証/鍵管理: YouTube OAuthはローカルエージェントで実施（トークンはローカルのみ保持）。Web
UIでは秘密を保存しない。

---

## 3. 主要ユースケース

- UC-1: ローカル起動 → 音声取り込み/認識 → 需要時のみコメント投稿（A案）
- UC-2: 一時停止/再開（投稿のみ停止、認識は継続可）
- UC-3: 安全レベル切替（strict/standard/relaxed）
- UC-4: Web UIで設定編集 → ローカルが設定を同期/反映
- UC-5: 停止（Webサーバー/OAuthローカルコールバックがあれば必ず停止）

---

## 4. 機能設計

### 4.1 コメント機会検知

- 入力: 直近N秒の発話テキスト
- ルール: 質問/呼びかけ、デモ、話題転換、視聴者配慮
- LLM分類: 必要/不要/保留
- 出力: {shouldComment: boolean, reason: string, confidence: 0..1}

### 4.2 コメント生成

- 入力: コンテキスト（要約/固有名詞/直近発話）、設定（口調/NG/推奨/長さ）
- 出力: 短文（min/max文字数内）
- フォールバック: テンプレート

### 4.3 安全フィルタ

- レベル: strict/standard/relaxed
- 外部API+ルール（NG語、絵文字頻度、PII）
- 出力: {approved: boolean, text: string, reason?: string}

### 4.4 投稿制御（A案）

- 実装位置: ローカルエージェント
- レート制限、クールダウン、重複/類似抑止
- 失敗時は指数バックオフで再試行（上限回）

---

## 5. 設定設計

- 形式: YAML（ローカル）。必要に応じてVercel上の設定を取得しマージ
- スキーマ: `要件定義書.md`
  記載（app/platforms/audio/stt/llm/persona/contentPolicy/triggerPolicy/safety/logging/telemetry）
- バリデーション: 起動時に型チェック（any/unknown不使用）
- 秘密/トークン: ローカルのみ保持。Vercel側に保存しない

---

## 6. 例外/エラーハンドリング

- STT/LLM/投稿API失敗: 再試行/フォールバック/抑止
- モデレーションNG: 投稿しない（理由を記録）
- 設定不整合: 起動エラーで明示
- ログ方針: エラー時のみ最小限保存、PIIマスク

---

## 7. 非機能設計

- 目標遅延: 1–3秒
- セキュリティ: 秘密情報はローカルのみ、最小権限
- 運用: CLIで制御、停止時には起動中のWebサーバーを必ずkill（ローカルOAuthコールバック含む）

---

## 8. 将来拡張

- Zoomアダプタ追加（チャット投稿、音声は同方式）
- Next.js Web UIの拡充（設定の差分/プレビュー）。秘密は保存しない

---

## 9. 実装に必要な事項

- **YouTube OAuth/権限（要確認含む）**
  - ローカルでOAuthフロー実施。`redirectUri`: `http://localhost:8787/callback`
  - トークン保存はローカルのみ（例: `~/.comment-bot/credentials.json`、権限600）
  - 自動リフレッシュ対応（期限切れ時の更新）
  - 必要スコープ（要確認）: `https://www.googleapis.com/auth/youtube.force-ssl` もしくは
    `https://www.googleapis.com/auth/youtube`
  - レート/クオータ監視、HTTP 401/403/429/5xxの扱い（再認証/バックオフ/中断）
- **Live Chat ID 取得**
  - 優先: 設定で`liveChatId`を直接指定
  - 代替（要確認）: `liveBroadcasts.list`等からアクティブ配信の`liveChatId`を取得
- **音声キャプチャ（macOS）**
  - BlackHole 2chの導入手順と`deviceName`設定、マルチ出力構成
  - 16kHz/monoへの変換、入力バッファサイズ、ドロップ時のリカバリ
  - 代替: Loopback構成（アプリ単位ルーティング）
- **STT（ストリーミング）**
  - プロバイダ選定（GCP/Azure/Deepgram/Whisper）。資格情報はローカル環境変数
  - interimとfinalの取り扱い、ネットワーク遮断時の再接続方針
  - VAD/ノイズ抑制パラメータの設定化
- **コメント機会検知**
  - ルールしきい値（質問/呼びかけ、話題転換、デモ、視聴者配慮）
  - LLM分類のモデル/温度/タイムアウト
  - クールダウン/重複抑止（文字列距離/正規化比較）
- **コメント生成（LLM）**
  - モデル、温度、最大トークン、タイムアウト
  - プロンプトテンプレート（口調/方針/NG/推奨/長さ）
  - フォールバックテンプレート（安全フィルタでNG時）
- **安全フィルタ**
  - プロバイダ（OpenAI）とカテゴリ/スコアしきい値
  - PII検出時の伏字/抑止、失敗時のルールベース代替
- **YouTube投稿（A案: ローカル直接）**
  - `liveChatMessages.insert`の実装
  - メッセージ長上限は200字目安で短縮。分割は最大2件・間隔>=クールダウン
  - バックオフ（指数）、重複/類似投稿の抑止
- **スケジューラ/レート制御**
  - `minIntervalSeconds`=60, `maxPer10Min`=8, `cooldownSeconds`=45, `dedupeWindowSec`=300（初期値）
  - 同義反復の距離指標（簡易類似度）
- **設定・同期（Next/Vercel）**
  - UIは機微情報を保存しない。サニタイズ済み設定のみ配布（Edge Config/KV）
  - ローカルは起動時/明示操作で同期し、YAMLへマージ
- **CLI/プロセス管理**
  - `start/pause/resume/stop`、SIGINT/SIGTERMハンドリング
  - 起動したWebサーバー（OAuthコールバック）は停止時に必ずkill
- **型/品質/ビルド**
  - TypeScript strict（`noImplicitAny`, `exactOptionalPropertyTypes`等）。`any`/`unknown`禁止
  - ESLint/Prettier。Node LTS、Next.js v14+（UI側）
  - 最低限の統合テスト（モックでAPIを代替）。ビルド通過の確認

## 10. Web UIライブラリ選定

- Tailwind CSS（スタイル）
- Radix UI（プリミティブ/A11y）
- shadcn/ui（実用コンポーネント）
- react-hook-form + zod（型安全フォーム）
- lucide-react（アイコン）
- next-themes（任意, ダークモード）、clsx/tailwind-merge（クラス合成）

原則: クライアント直フェッチ禁止。Server Actions/Route Handlersのみを使用。
