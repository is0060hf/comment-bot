# コメントBot 要件定義書（YouTube優先／将来Zoom拡張）

- ドキュメント版: v0.1（初稿）
- 作成日: 2025-10-11
- 対象リポジトリ: `comment-bot`

---

## 1. 背景・目的

配信（ライブストリーミング）の内容を音声認識で常時把握し、文脈に沿った「自然で有用」なコメントを、適切なタイミングで自動投稿するBotを実現する。第一段階はYouTube
Liveを対象とし、将来的にZoom等のオンラインセミナーへ拡張可能な構成とする。

## 2. スコープ

- 対象プラットフォーム（Phase 1）: YouTube Live
- 将来拡張（Phase 2 以降）: Zoom等のオンラインセミナー
- 実行環境: macOS（Darwin 24.x）
- 言語: 日本語（多言語は対象外）
- UI: 当面はCLI。将来的に簡易UIを検討
- API呼び出し: サーバーサイドのみで実施（クライアントからの直接フェッチは禁止）

## 3. 事実・前提（確定事項）

- Bot専用のYouTubeアカウントを用いる
- コメント頻度は「一定間隔」ではなく「話題や文脈に応じて」投下する
- 口調・キャラクター像・NG表現・推奨表現は設定ファイルで調整可能にする
- 安全フィルタの強度はユーザーが選択可能にする
- ログは原則保存しないが、エラー時のみデバッグに必要な最小限を保存する
- クラウドサービス（STT/LLM/モデレーション）は積極的に併用可
- 日本語のみ対応
- APIはサーバーサイドからのみ呼び出す

## 4. 仮定・補足（推測と確度）

- 音声取り込みは仮想オーディオデバイス（BlackHole/Loopback）利用が実務上の最適解（高確度）
- YouTubeへの投稿はYouTube Data API v3の`liveChatMessages.insert`を用いる（高確度）
- レイテンシ目標はSTT+生成で全体1–3秒（中〜高確度）

## 5. 全体アーキテクチャ（概要）

- 音声入力層: 仮想オーディオデバイス（BlackHole 2chやLoopback）からシステム/配信音声を取得
- STT層: 低遅延の日本語ストリーミングSTT（例: GCP/Azure/Deepgram/Whisper API）
- コンテキスト管理: 直近の要約・話題・固有名詞・NG情報のスライディングウィンドウ保持
- コメント機会検知: ヒューリスティクス+LLM分類で「今コメントが求められているか」を推定
- コメント生成: 設定された方針・口調・NG/推奨表現・長さ制約をプロンプト化してLLM生成
- 安全フィルタ: 規約違反/攻撃的/機密/誤情報リスクを多段で検知・抑止
- 投稿: サーバーサイドでYouTube Live Chatへ投稿（レート制限/バックオフ/重複抑制）
- 設定/運用: YAML/TOMLで設定、CLIで開始/停止・一時停止・安全レベル切替

```
[音声入力] → [STT(ストリーミング)] → [コンテキスト管理]
                             ↓
                 [コメント機会検知] → [安全フィルタ] → [投稿(YouTube)]
                             ↑                 ↓
                          [LLM生成] ← [テンプレートFallback]
```

## 6. 機能要件（F）

### F-1. 音声取り込み

- 入力: macOS上の仮想オーディオデバイスからのPCMストリーム
- 推奨構成（優先度順）
  1. BlackHole 2ch + マルチ出力（スピーカーとBlackHoleへ同時出力）
  2. Loopback（有償・柔軟なルーティング）
  3. OBSのモニタ出力をBlackHole/Loopbackへ
- 仕様:
  - サンプルレート: 内部で16 kHz/monoへ変換
  - VAD/ノイズ抑制/AGCの有効化（STT側または前処理）

### F-2. STT（音声認識）

- 日本語ストリーミング認識、部分（interim）→確定（final）結果をイベントで受領
- 候補プロバイダ: GCP Speech-to-Text v2 / Azure Speech / Deepgram / OpenAI Whisper API
- 目標遅延: 0.5–2.0秒（ネットワーク依存）

### F-3. コンテキスト管理

- 直近X分の要点・話題・固有名詞・CTA（呼びかけ）を軽量要約
- スライディングウィンドウで更新し、生成/検知へ提供

### F-4. コメント機会検知（需要判定）

- ルール例（日本語特化）
  - 質問/呼びかけ: 「どう思いますか？」「ご意見」「コメントで教えて」
  - デモ/山場: 「やってみます」「結果はこちら」「成功/失敗」
  - 話題転換: 「次は」「さて」「続いて」「ここで」
  - 視聴者配慮: 「聞こえますか？」「見えますか？」
- スコアリング→しきい値超で候補化、クールダウン（例: 45–90秒）
- LLM分類で「必要/不要/保留」を2–3値判定
- 連投/同義反復の抑止（類似度/重複フィルタ）

### F-5. コメント生成

- LLMに方針・口調・NG/推奨表現・長さ制約を与えて短文生成
- 生成失敗/安全フィルタでNG時はテンプレートへフォールバック

### F-6. 安全フィルタ

- レベル: `strict` / `standard` / `relaxed`（設定で選択）
- 実装: モデレーションAPI（例: Azure AI Content Safety / OpenAI Moderation）+ ルール
- PII（個人情報）検知時は伏字や生成抑止を適用（設定）

### F-7. 投稿（YouTube）

- サーバーサイドからYouTube Liveチャットへ投稿
- 認証: OAuth（Bot用アカウント）
- レート制御: `minIntervalSeconds`, `maxPer10Min`, `cooldownSeconds`, 類似重複の抑制
- 障害時のバックオフと再試行（上限回数）

### F-8. 設定/CLI

- 設定はYAML/TOML（初期はYAML）
- CLI: `start`/`pause`/`resume`/`safety`/`stop`
- 一部設定はホットリロード（安全に影響する項目は再起動時にのみ反映）

### F-9. ログ/テレメトリ

- ログ保存: 原則なし。エラー時のみ最小限（PIIはマスク）
- メトリクス: ローカルのみ（呼び出し回数、成功/失敗率）。保存しない

## 7. 非機能要件（NFR）

- パフォーマンス: E2E遅延1–3秒を目安（STT+生成+投稿）
- 信頼性: リトライ/バックオフ、テンプレートフォールバックで可用性を確保
- セキュリティ: OAuth秘密情報の安全管理、PIIマスキング、最小権限
- 規約順守: プラットフォーム規約・レート制限の厳守、スパム防止
- 運用性: CLI操作、エラーログのみ保存、容易な停止/一時停止
- 保守性: プロバイダ切替可能なアダプタ構成（STT/LLM/モデレーション/プラットフォーム）

## 8. 音声取り込みベストプラクティス（macOS）

1. BlackHole 2ch + マルチ出力デバイス
   - システム出力をスピーカーとBlackHoleへ同時出力
   - BotはBlackHoleを入力デバイスとして取得
2. Loopback（有償）
   - アプリ単位で柔軟にルーティング（ブラウザ/OBS/Zoomの音声のみを収集）
3. OBSモニタ出力
   - OBSのモニタリング出力先をBlackHole/Loopbackに設定

（注）配信URLからの直接取得は、遅延・安定性・規約・実装コスト面で上記方式に劣る場合が多い。

## 9. 設定項目（スキーマ案）

- app
  - `language`: 固定 `ja-JP`
  - `runMode`: `youtube`（将来`zoom`等追加）
- platforms.youtube
  - `auth`: OAuthクライアント情報（Bot専用）
  - `channelId` or `liveChatId`: 自動取得/手動指定
  - `postPolicy`: `minIntervalSeconds`, `maxPer10Min`, `cooldownSeconds`, `dedupeWindowSec`
- audio
  - `deviceName`: "BlackHole 2ch" 等
  - `sampleRateHz`: 16000, `channels`: 1
- stt
  - `provider`: `gcp` | `azure` | `deepgram` | `openai_whisper`
  - `model`: 日本語向けモデル名
  - `interimResults`: bool, `vad`: bool, `noiseSuppression`: bool
- llm
  - `provider`: `openai` | `azure_openai` | `anthropic` 等
  - `model`: 生成用, `classifierModel`: 機会検知用
  - `temperature`, `maxTokensPerComment`
- persona
  - `tone`: `丁寧` | `フレンドリー` | `カジュアル` | `熱量高め` | `落ち着き`
  - `style`: 複数可（例: 前向き, 応援寄り, ユーモア少し）
  - `personaName`, `dialect`: `標準語`
- contentPolicy
  - `ngWords`: 明示リスト
  - `preferredPhrases`: 推奨フレーズ
  - `length`: `minChars`, `maxChars`
  - `emojisAllowed`: bool, `allowedEmojis`: list
- triggerPolicy
  - `enabledTriggers`: [`question`, `topicShift`, `demo`, `cta`]
  - `topicShiftWindowSec`, `askForOpinionPhrases`
  - `repetition.minUniqueDistance`
- safety
  - `level`: `strict` | `standard` | `relaxed`
  - `providers`: [`azure_content_safety`, `openai_moderation`, `rule_based`]
  - `piiRedaction`: bool
- logging
  - `mode`: `errors_only`, `redactPII`: bool, `retentionDaysOnError`: 日数
- telemetry
  - `metrics`: `local_only`

### 設定ファイル例（YAML）

```yaml
app:
  language: ja-JP
  runMode: youtube

platforms:
  youtube:
    auth:
      oauthClientId: 'YOUR_CLIENT_ID'
      oauthClientSecret: 'YOUR_CLIENT_SECRET'
      redirectUri: 'http://localhost:8787/callback'
    channelId: 'UCxxxxxxxxxxxxxxxx'
    postPolicy:
      minIntervalSeconds: 60
      maxPer10Min: 8
      cooldownSeconds: 45
      dedupeWindowSec: 300

audio:
  deviceName: 'BlackHole 2ch'
  sampleRateHz: 16000
  channels: 1

stt:
  provider: gcp
  model: 'latest-ja-conversational'
  interimResults: true
  vad: true
  noiseSuppression: true

llm:
  provider: openai
  model: 'gpt-4o-mini'
  classifierModel: 'gpt-4o-mini'
  temperature: 0.6
  maxTokensPerComment: 80

persona:
  tone: 丁寧
  style: ['フレンドリー', '前向き']
  personaName: 'CommentBot'
  dialect: 標準語

contentPolicy:
  ngWords: ['暴力的表現', '差別的表現', '下品な表現']
  preferredPhrases: ['ナイスです！', '良いですね！', '助かります！']
  length:
    minChars: 12
    maxChars: 80
  emojisAllowed: true
  allowedEmojis: ['👏', '✨', '🙏', '💡']

triggerPolicy:
  enabledTriggers: ['question', 'topicShift', 'demo', 'cta']
  topicShiftWindowSec: 90
  askForOpinionPhrases: ['どう思いますか', 'ご意見', 'コメントで教えて']
  repetition:
    minUniqueDistance: 5

safety:
  level: standard
  providers: ['azure_content_safety', 'rule_based']
  piiRedaction: true

logging:
  mode: errors_only
  redactPII: true
  retentionDaysOnError: 7

telemetry:
  metrics: local_only
```

## 10. CLIインターフェース（想定）

- 起動: `comment-bot start --config ./config.yaml`
- 一時停止/再開: `comment-bot pause` / `comment-bot resume`
- 安全レベル切替: `comment-bot safety --level strict`
- 停止: `comment-bot stop`（起動中のWebサーバーがある場合は必ず停止）

## 11. 受け入れ条件（PoC）

- BlackHole等で音声を取り込み、STTが日本語で連続認識できる
- コメント機会検知が動作し、不要時は抑止される
- LLMで短文が生成され、方針・口調・長さ・NG/推奨表現を遵守
- 安全フィルタで問題表現がブロック/修正される
- YouTube Liveチャットへサーバーサイドから投稿でき、レート制御が効く
- CLIで開始/停止・安全レベル切替が行える
- ログはエラー時のみ最小限が保存され、PIIはマスクされる

## 12. リスクと対策

- OAuth/クオータ: 最新のYouTube Data APIクオータに依存 → クオータ監視と投稿頻度調整
- 音声品質: VAD/ノイズ抑制/AGCの調整、入力デバイス選定
- モデレーション誤検知: 複合判定（外部API+ルール）とテンプレフォールバック
- 依存API障害: STT/LLM/モデレーションのプロバイダ切替を容易にするアダプタ設計
- スパム/類似連投: クールダウン・重複抑止・最大件数制限

## 13. 将来拡張（Zoom等）

- 音声取り込みは同一方式で流用可（LoopbackでZoom音声のみ抽出など）
- チャット投稿はZoom用アダプタを`platforms.zoom`として追加
- 既存の機会検知/生成/安全/投稿パイプラインを共通化

---

本要件定義書は、サーバーサイドのみでAPIを呼び出す方針、ログ最小化方針、日本語特化、設定による柔軟な運用という基本原則を満たしつつ、低遅延かつ安全に文脈適合コメントを提供することを目的とする。
