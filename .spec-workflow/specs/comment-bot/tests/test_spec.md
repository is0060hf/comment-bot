# テスト仕様（comment-bot）

## 1. 概要

- 目的: 各タスクのRed/Green/Refactor/Verifyを実施できるよう、期待挙動を明確化
- 対象: `.spec-workflow/specs/comment-bot/{requirements.md, design.md, tasks.md}` に準拠

## 2. テストポリシー

- 単体: ルール/分類/生成/モデレーション/投稿アダプタの各関数
- 統合: STT→検知→生成→安全→投稿（外部APIはモック）
- 非機能: レイテンシ目標、レート制御、ログ方針（エラー時のみ）

---

## 3. テストケース（タスク対応）

### TC-011: プロバイダ優先/フェイルオーバー

- 対応タスク: 11
- 期待:
  1. STT: deepgramが失敗→gcp→whisperへ順次フェイルオーバー
  2. LLM: openaiのみ使用（障害時はテンプレfallback）
  3. Safety: openai_moderation失敗→rule_based
- 検証: 各フェイルポイントで次順位に切替するログ・戻り値

### TC-012: 設定初期値の適用/マージ

- 対応タスク: 12
- 期待: YAML既定値（stt=gcp, llm=gpt-4o-mini, moderation=[openai_moderation, rule_based],
  safety=standard）がロードされ、UI編集（サニタイズ済）がマージされる
- 検証: Zod等のスキーマでバリデーションPass、反映結果が型安全

### TC-013: コメント長ポリシー（20–60文字）

- 対応タスク: 13
- 期待: LLM出力が範囲外なら短縮/再生成され、最終文字数が20–60に収まる
- 検証: 単体（フォーマッタ）＋統合（生成→整形）

### TC-014: NG語検出（正規化）

- 対応タスク: 14
- 期待: かな/半角全角/繰返し/記号を正規化後にNG検出できる
- 検証: バリエーション入力に対し同一NG判定を返す

### TC-015: 絵文字ポリシー（最大1・許可リスト）

- 対応タスク: 15
- 期待: 許可外絵文字は除去、2個以上は1個へ削減、連投時の類似抑止が効く
- 検証: メッセージ単位の整形、直近との類似度による抑止

### TC-016: プロンプト更新（生成/分類）

- 対応タスク: 16
- 期待: 口調/方針/長さ/NG/絵文字方針を満たす出力。分類は必要/不要/保留を良好に識別
- 検証: モックLLMでプロンプト効果を比較

### TC-017: モデレーション閾値とリライトfallback

- 対応タスク: 17
- 期待: 高リスク→ブロック、軽度→リライト→再検査→不可ならブロック
- 検証: カテゴリ別に分岐、再検査の合否

### TC-018: tsumiki-cursor 参照モードの動作

- 対応タスク: 18
- 期待:
  `kairo.sh`/`tdd.sh`/`reverse.sh`が`.spec-workflow/specs/comment-bot/`を参照し、案内が本プロジェクト名で表示される
- 検証: スクリプト実行時の出力内容（Dry run）

### TC-019: serenaメモリ参照

- 対応タスク: 19
- 期待: 要件/設計/ポリシーがメモリ参照で提示可能
- 検証: 主要項目（プロバイダ優先/コメント長/絵文字/NG語/サーバーサイド原則）を回答

---

## 4. 統合E2E（モック）

- シナリオ: 音声（モック）→STT（モック）→検知→生成→安全→投稿（モック）
- 期待: 「必要時のみ」1件投稿、20–60字、許可絵文字≤1、NGなし、レート制御遵守

## 5. 非機能テスト

- レイテンシ: end-to-end 1–3秒（モック時は計測目安）
- ログ: 通常時は保存なし、エラー時のみ最小限（PIIマスク）

## 6. Verify基準

- 単体/統合/非機能の成功＋specsと設計の整合性
