# テーブル設計書（YouTubeコメントBot）

- 版: v0.2
- 作成日: 2025-10-11
- 根拠: `doc/要件定義書.md`

---

## 前提
- Phase 1（PoC）は永続RDBを必須としない（ログはエラー時のみ最小限）。
- A案: 投稿・秘密はローカルのみ。Web UI（Vercel）は設定の配布/編集に限定し、秘密は保存しない。

## 想定ストレージ選択肢
- RDB（将来）: PostgreSQL/Aurora、開発はSQLite
- KV/Edge Config（Vercel, 任意）: 設定の配布用（読取中心）。秘密は保存しない
- 構成はアダプタで切替可能に設計

---

## 論理テーブル定義（将来）

### T_CONFIG_SNAPSHOTS（設定スナップショット）
- 用途: 重大変更時の設定差分の監査用。デフォルトでは保存しない、オプトイン。
- 主キー: `id` (UUID)
- カラム
  - `id` (UUID, PK)
  - `created_at` (timestamptz)
  - `config_hash` (char(64)) - ハッシュ
  - `config_yaml` (text) - PII/秘密はマスク済み

### T_ERROR_LOGS（エラーログ）
- 用途: 例外・投稿失敗時のみ最小限保存（PIIマスク）
- 主キー: `id` (UUID)
- カラム
  - `id` (UUID, PK)
  - `occurred_at` (timestamptz)
  - `component` (varchar(64)) - 例: stt, llm, youtube
  - `error_code` (varchar(64))
  - `http_status` (int) - 該当時
  - `message` (varchar(1024)) - マスク済
  - `context` (jsonb) - 最小限のデバッグ情報

### T_MODERATION_EVENTS（モデレーション結果）
- 用途: モデレーションNGや修正適用の監査（オプトイン）
- 主キー: `id` (UUID)
- カラム
  - `id` (UUID, PK)
  - `checked_at` (timestamptz)
  - `level` (varchar(16)) - strict/standard/relaxed
  - `provider` (varchar(32))
  - `result` (jsonb) - しきい値/カテゴリ/理由

---

## KV/Edge Config スキーマ（Vercel, 任意）
- 目的: UIで編集した設定を配布（ローカルに手動/自動反映）。秘密/トークンは保存しない
- キー例
  - `config/current` : JSON化した設定（秘密/トークン/Pii除去）。`schemaVersion`, `updatedAt`, `payload`
  - `config/schemaVersion` : 現行スキーマ版
  - `safety/defaultLevel` : strict/standard/relaxed
- `config/current.payload` 構造（例）
  - `app`, `platforms.youtube.postPolicy`, `audio`, `stt`, `llm`, `persona`, `contentPolicy`, `triggerPolicy`, `safety`
- サイズ制限: Edge Configの制限に収まるよう、最小限に保持

---

## インデックス方針（RDB想定）
- 時系列アクセスが主: `*_at`にB-Tree
- クエリ最適化は将来の運用状況を見て追加

## マスキング/PII
- ログ/スナップショット/KVにおけるPII/秘密は必ずマスク
- 保存はエラー時/オプトイン時のみ

## マイグレーション方針
- 変更はDDLマイグレーションツールで管理（例: Prisma/MigrateやKnex）
- 本番適用はメンテナンス手順に従う

## 実装に必要な事項
- **KV/Edge Config 運用**
  - サニタイズ済み設定のみ格納。秘密/トークン/PIIを保存しない
  - キー命名規則（例）: `config/current`, `config/schemaVersion`, `safety/defaultLevel`
  - サイズ/レイテンシ制約を考慮（必要最小限のみ）
- **RDB（将来）**
  - スキーマのバージョン管理（DDLマイグレーション）
  - インデックス/制約の検討（`*_at`時系列インデックス）
  - PIIマスク、保存はエラー/オプトイン時のみ
- **ログ保持**
  - 例外発生時のみ最小限。保存期間の上限、出力先パスの固定化
- **型厳格化**
  - アプリ層から渡る構造体のスキーマを定義し、`any`/`unknown`禁止
